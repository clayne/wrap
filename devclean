#! /bin/bash
##
#       devclean -- remove all auto-generated files
#
#       Copyright (C) 2015  Paul J. Lucas
#
#       This program is free software; you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation; either version 2 of the Licence, or
#       (at your option) any later version.
#
#       This program is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#
#       You should have received a copy of the GNU General Public License
#       along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

# Uncomment for shell debugging.
#set -x

########## Declarations #######################################################

ME=$(basename "$0")

usage() {
  cat >&2 <<END
usage: $ME [-d]

-d: Do a dry run: print what would be done but don't actually do it.
END
  exit 1
}

########## Parse command-line options #########################################

while getopts d opt
do
  case $opt in
  d)  ECHO=echo ;;
  ?)  usage ;;
  esac
done
shift $(( OPTIND - 1 ))
(( $# == 0 )) || usage

########## Main ###############################################################

find . -name .gitignore | while read ig_file
do
  ig_dir=$(dirname $ig_file)
  rm -f $ig_dir/*~
  while read ig_pattern
  do
    no_slash=${ig_pattern#/}
    if [[ $no_slash == $ig_pattern ]]
    then $ECHO find $ig_dir -name "$ig_pattern" -exec rm -fr {} \; -prune
    else $ECHO rm -fr $ig_dir/$no_slash
    fi
  done < $ig_file
done

###############################################################################
# vim:set et sw=2 ts=2:
